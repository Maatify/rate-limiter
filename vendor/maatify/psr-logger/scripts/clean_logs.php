#!/usr/bin/env php
<?php
/**
 * Created by Maatify.dev
 * User: Maatify.dev
 * Date: 2025-11-05
 * Time: 08:40
 * Project: maatify/psr-logger
 * IDE: PhpStorm
 * https://www.Maatify.dev
 *
 * Description:
 * CLI tool to automatically clean old logs generated by Maatify PSR Logger.
 * Can be executed directly or scheduled via CRON jobs.
 *
 * Example usage:
 * ```bash
 * chmod +x scripts/clean-logs.php
 * ./scripts/clean-logs.php
 * ```
 *
 * Example cron configuration:
 * ```bash
 * 0 0 * * * /usr/bin/php /var/www/project/vendor/maatify/psr-logger/scripts/clean-logs.php >> /var/www/project/storage/logs/cron.log 2>&1
 * ```
 */

declare(strict_types=1);

/**
 * Smart base directory detection:
 * - If installed inside `vendor/maatify/psr-logger`, move 3 levels up to reach project root.
 * - If running standalone (for development or testing), move one level up from /scripts.
 */

use Dotenv\Dotenv;
use Maatify\PsrLogger\Rotation\LogCleaner;
/**
 * @return string
 */
function getDirname(): string
{
    $vendorPos = strpos(__DIR__, '/vendor/');

    if ($vendorPos !== false) {
        // ðŸ§© Library used inside a project
        $baseDir = dirname(__DIR__, 3);
    } else {
        // ðŸ§ª Standalone development mode
        $baseDir = dirname(__DIR__);
    }

    // Autoload dependencies (project or library scope)
    $autoloadPath = file_exists($baseDir . '/vendor/autoload.php')
            ? $baseDir . '/vendor/autoload.php'
            : __DIR__ . '/../vendor/autoload.php';

    require $autoloadPath;

    return $baseDir;
}

$baseDir = getDirname();

// Load environment variables (if .env exists)
if (file_exists($baseDir . '/.env')) {
    Dotenv::createImmutable($baseDir)->load();
}

// ðŸ§¹ Execute log cleanup
LogCleaner::cleanOldLogs();

echo "âœ… Old logs cleaned successfully.\n";
