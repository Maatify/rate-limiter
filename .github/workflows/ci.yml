name: ðŸš€ CI â€“ Maatify Rate Limiter
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ðŸ§ª Run PHPUnit Tests
    runs-on: ubuntu-latest

    services:
      ðŸ§± redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      ðŸ¬ mysql:
        image: mysql:8.3
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: maatify_test
        ports:
          - 3306:3306
        options: >-
          --default-authentication-plugin=mysql_native_password
          --character-set-server=utf8mb4
          --collation-server=utf8mb4_general_ci
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      ðŸƒ mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: redis, pdo_mysql, mongodb
          coverage: xdebug
          tools: composer

      - name: ðŸ©º Verify Services Health
        run: |
          echo "ðŸ” Installing client tools for service health checks..."
          sudo apt-get update -qq
          sudo apt-get install -y redis-tools mongodb-tools > /dev/null
          echo "ðŸ” Checking services health..."
          redis-cli -h 127.0.0.1 ping
          mysql -h 127.0.0.1 -uroot -proot -e "SHOW DATABASES;"
          mongosh --eval "db.runCommand({ ping: 1 })"

      - name: ðŸ“¥ Install Composer Dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress
          composer dump-autoload -o

      - name: ðŸ§¾ Prepare .env Configuration
        run: |
          cp .env.example .env
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "MYSQL_DSN=mysql:host=127.0.0.1;dbname=maatify_test" >> .env
          echo "MYSQL_USER=root" >> .env
          echo "MYSQL_PASS=root" >> .env
          echo "MONGO_URI=mongodb://127.0.0.1:27017" >> .env
          echo "MONGO_DB=maatify_test" >> .env

      - name: ðŸ§ª Run PHPUnit Tests
        run: |
          echo "âœ… Local test environment loaded."
          vendor/bin/phpunit --configuration phpunit.xml --colors=always

      - name: ðŸ“¤ Upload Test Results (Optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸ§ª phpunit-results
          path: tests/_output/
