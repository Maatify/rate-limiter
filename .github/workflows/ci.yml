name: ðŸš€ CI â€“ Maatify Rate Limiter

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ðŸ§ª Run PHPUnit Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: maatify_test
          MYSQL_USER: maatify
          MYSQL_PASSWORD: maatify
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -uroot -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 18

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: redis, pdo_mysql, mongodb
          coverage: xdebug
          tools: composer

      - name: ðŸ©º Verify Services Health
        run: |
          echo "ðŸ” Installing client tools for service health checks..."
          sudo apt-get update -qq
          sudo apt-get install -y redis-tools mysql-client curl gnupg > /dev/null
          curl -fsSL https://pgp.mongodb.com/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
          echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update -qq
          sudo apt-get install -y mongodb-mongosh > /dev/null

          echo "â³ Waiting for Redis to be ready..."
          for i in {1..10}; do
            if redis-cli -h 127.0.0.1 -p 6379 ping > /dev/null 2>&1; then
              echo "âœ… Redis is ready!"
              break
            fi
            echo "ðŸ” Redis not ready yet, retrying ($i/10)..."
            sleep 2
          done

          echo "â³ Waiting for MySQL to be ready..."
          for i in {1..15}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -uroot -proot > /dev/null 2>&1; then
              echo "âœ… MySQL is ready!"
              break
            fi
            echo "ðŸ” MySQL not ready yet, retrying ($i/15)..."
            sleep 3
          done

          echo "â³ Waiting for MongoDB to be ready..."
          for i in {1..30}; do
            if mongosh "mongodb://127.0.0.1:27017" --eval "db.runCommand({ ping: 1 })" --quiet | grep -q '"ok" : 1'; then
              echo "âœ… MongoDB is ready!"
              break
            fi
            echo "ðŸ” MongoDB not ready yet, retrying ($i/30)..."
            sleep 3
          done

          if mongosh "mongodb://127.0.0.1:27017" --eval "db.runCommand({ ping: 1 })" --quiet | grep -q '"ok" : 1'; then
            echo -e "\033[0;32mðŸŸ¢ All services are healthy and ready to use!\033[0m"
          else
            echo -e "\033[0;33mâš ï¸ MongoDB still not responding after full wait, continuing anyway...\033[0m"
          fi

      - name: ðŸ“¥ Install Composer Dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress
          composer dump-autoload -o

      - name: ðŸ§¾ Prepare .env Configuration
        run: |
          cp .env.example .env
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "MYSQL_DSN=mysql:host=127.0.0.1;dbname=maatify_test" >> .env
          echo "MYSQL_USER=root" >> .env
          echo "MYSQL_PASS=root" >> .env
          echo "MONGO_URI=mongodb://mongo:27017" >> .env
          echo "MONGO_DB=maatify_test" >> .env

      - name: ðŸ§ª Run PHPUnit Tests
        run: |
          echo "âœ… Local test environment loaded."
          vendor/bin/phpunit --configuration phpunit.xml --colors=always

      - name: ðŸ“¤ Upload Test Results (Optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸ§ª phpunit-results
          path: tests/_output/
