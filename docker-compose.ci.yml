version: "3.9"

services:
  php:
    image: php:8.4-cli
    container_name: maatify-ci-php
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      mongo:
        condition: service_healthy
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MYSQL_DSN: mysql:host=mysql;dbname=maatify_test
      MYSQL_USER: root
      MYSQL_PASS: root
      MONGO_URI: mongodb://mongo:27017
      MONGO_DB: maatify_test
    command: >
      bash -c "
        echo 'ðŸ“¦ Installing Composer...' &&
        curl -sS https://getcomposer.org/installer | php &&
        mv composer.phar /usr/local/bin/composer &&
        echo 'ðŸ“¦ Installing dependencies...' &&
        composer install --no-interaction --no-progress --prefer-dist &&
        composer dump-autoload -o &&
        echo 'âœ… Running tests...' &&
        vendor/bin/phpunit --configuration phpunit.xml --colors=always
      "
  

  redis:
    image: redis:7
    container_name: maatify-ci-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  mysql:
    image: mysql:8.0
    container_name: maatify-ci-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: maatify_test
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  mongo:
    image: mongo:7
    container_name: maatify-ci-mongo
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 10
